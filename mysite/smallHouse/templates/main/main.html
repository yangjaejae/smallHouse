{% extends 'base_layout.html' %}
{% load staticfiles %}

{% block content %}
<div id="map" class="map" style="position:absolute; height:100%; width: 100%;">
    <div class="container-fluid top_layer" style="padding-right: 0px; padding-left: 0px;">
        <div class="col-md-4 top_layer_nav">
            <div class="input-group-lg top_layer_search">
                <input type="text" class="top_layer_keyword" onkeypress="if( event.keyCode==13 ){goSearch();}" placeholder="검색어를 입력하세요(ex.서초동)"/>
                <span class="btn btn-lg btn-default btn_search glyphicon glyphicon-search"></span>
            </div>
            <div class="dropdown" style="position: relative; top: 54%;">
                <button class="btn btn-default dropdown-toggle" id="menu1" type="button" data-toggle="dropdown">주택
                <ul class="dropdown-menu" role="menu" aria-labelledby="menu1">
                    <li role="presentation"><a role="menuitem" tabindex="-1" href="#">다세대 연립</a></li>
                    <li role="presentation"><a role="menuitem" tabindex="-1" href="#">전세</a></li>
                </ul>
                <button class="btn btn-default dropdown-toggle" id="menu1" type="button" data-toggle="dropdown">매매/전세
                <ul class="dropdown-menu" role="menu" aria-labelledby="menu1">
                    <li role="presentation"><a role="menuitem" tabindex="-1" href="#">매매</a></li>
                    <li role="presentation"><a role="menuitem" tabindex="-1" href="#">단독 다가구</a></li>
                </ul>
            </div>
            {% comment %} <div class="dropdown" style="position: relative; top: 54%;">
                <a data-toggle="dropdown" href="#">매매/전세</a>
                <ul class="nav nav-tabs dropdown-menu" role="menu">
                    <li role="presentation">
                        <a role="menuitem" tabindex="-1" href="#">메뉴1</a></li>
                    <li role="presentation"><a role="menuitem" tabindex="-1" href="#">메뉴1</a></li>
                </ul>
            </div> {% endcomment %}
            {% comment %} <div class="sub_filter dropdown" style="padding-top: 38px;">
                <ul class="nav nav-tabs">
                    <li class="col-md-6">
                        <a data-toggle="dropdown" href="#">매매/전세</a>
                        <ul class="dropdown-menu" role="menu">
                            <li role="presentation"><a role="menuitem" tabindex="-1" href="#">매매</a></li>
                            <li role="presentation"><a role="menuitem" tabindex="-1" href="#">전세</a></li>
                        </ul>
                    </li>
                    <li class="col-md-6">
                        <a data-toggle="dropdown" href="#">주택</a>
                        <ul class="dropdown-menu" role="menu">
                            <li role="presentation"><a role="menuitem" tabindex="-1" href="#">다세대 연립</a></li>
                            <li role="presentation"><a role="menuitem" tabindex="-1" href="#">단독 다가구</a></li>
                        </ul>
                    </li>
                </ul>
            </div> {% endcomment %}
        </div>
        <div class="visible-md visible-lg col-md-4 top_layer_info" style="overflow: scroll;">
            <div class="info_nav" style="background-color: cornflowerblue; color:white; text-align:center;">
                <div class="visible-xs visible-sm glyphicon glyphicon-chevron-left btn_left_news_back"></div>
                <span><h3>부동산 뉴스</h3></span>
                <a href="#" class="visible-md visible-lg btn_toggle_content" style="color:white;">접기<span class="caret"></span></a>
            </div>
            <div class="info_nav_text">
                <table>
                    {% for new in news %}
                    <tr>
                        <td>
                            <a href="{{ new.url }}">
                                <p>{{ new.title }}</p>
                            </a>
                            <p>-{{ new.newspaper }}-</p>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
    <!-- 클릭 후 상세 정보 -->
    <div class="col-md-3 wrap_info_house">
        <div class="top_layer_nav">
            <div class="input-group-lg top_layer_search">
                <input type="text" class="top_layer_keyword" onkeypress="if( event.keyCode==13 ){goSearch();}" placeholder="검색어를 입력하세요(ex.서초동)"/>
                <span class="btn btn-lg btn-default btn_search glyphicon glyphicon-search"></span>
            </div>
            <div class="sub-filter">
                <div class="sub-filter-layer">
                    <div class="menu-container">
                    </div>
                </div>
            </div>
        </div>
        <div class="header_info">
            <div class="house_title">
                <span class="btn btn-lg btn-default btn_back glyphicon glyphicon-chevron-left" style=""></span>
                <span><a href="#"><h4 id="detail_name">주택명</h4></a></span>
            </div>
            <div class="text-center address_info">
                <p id="detail_addr"></p>
                <p id="detail_addr_detail"></p>
            </div>
        </div>
        <div class="type_select">
            <ul class="nav nav-pills">
                <li class="col-md-6 active">
                    <a data-toggle="dropdown" href="#">매매/전세</a>
                    <ul class="dropdown-menu" role="menu">
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">매매</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">전세</a></li>
                    </ul>
                </li>
                <li class="col-md-6 active">
                    <a data-toggle="dropdown" href="#">주택</a>
                    <ul class="dropdown-menu" role="menu">
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">다세대 연립</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">단독 다가구</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class="text-center realprice_avg" style="position: relative">
            <div>최근 3개월 실거래 평균</div>
            <div id="detail_price_avg">없음</div>
            <div><blockquote class="pull-right"><a href="#"><h6>국토교통부 거래가격</h6></a></blockquote></div>
        </div>
        <hr/>
        <div class="realPrice_table">
            <table class="table table-hover">
                <tr>
                    <th>계약일</th>
                    <th>가격</th>
                    <th>전용면적</th>
                    <th>층</th>
                </tr>
                <tr>
                    <td>2017.4</td>
                    <td>12,000</td>
                    <td>107.2</td>
                    <td>3</td>
                </tr>
                <tr>
                    <td>2017.4</td>
                    <td>12,000</td>
                    <td>107.2</td>
                    <td>3</td>
                </tr>
                <tr>
                    <td>2017.4</td>
                    <td>12,000</td>
                    <td>107.2</td>
                    <td>3</td>
                </tr>
            </table>
        </div>
    </div>
    <!-- side button -->
    <div class="visible-xs visible-sm left_button">
        <div class="col-md-1">
            <button class="btn btn-default btn_left_news glyphicon glyphicon-list-alt"></button>
        </div>
        <div class="col-md-1">
            <button class="btn btn-default btn_left_near glyphicon glyphicon-road"></button>
        </div>
        <div class="col-md-1">
            <button class="btn btn-default btn_left_poppul glyphicon glyphicon-user"></button>
        </div>
    </div>
    <div class="right_button">
        <div class="col-md-1">
            <button class="btn btn-default btn_right_loc glyphicon glyphicon-screenshot"></button>
        </div>
        <div class="col-md-1">
            <a><button class="btn btn-default btn_glob_0 glyphicon glyphicon-globe"></button></a>
            <ul class="pull-left">
                <li><button class="btn btn-default btn_glob_1 glyphicon glyphicon-leaf" style="position: absolute; opacity: 0; right: 50px; top: 11px;"></button></li>
                <li><button class="btn btn-default btn_glob_2 glyphicon glyphicon-fire" style="position: absolute; opacity: 0; right: 90px; top: 11px;"></button></li>
            </ul>
        </div>
        <div class="col-md-1">
            <button class="btn btn-default btn_right_dist glyphicon glyphicon-resize-horizontal"></button>
        </div>
        <div class="col-md-1">
            <button class="btn btn-default btn_right_hide glyphicon glyphicon-map-marker"></button>
        </div>
    </div>
    <div class="bottom_current_loc_info">
        <div class="btn btn-info ">
            <span class="glyphicon glyphicon-map-marker"></span>
            <span class="btn_loc_info"></span>
        </div>
    </div>
    
</div>
<script>
    //map initiate
    var map = null;

    //info window
    var infowindow = new naver.maps.InfoWindow();
    
    //marker cluster용 배열
    var markers = []
    
    var dataList = []

    var mapOptions = {
        center: new naver.maps.LatLng(37.498189, 127.027642),
        zoom: 10,
        minZoom: 1, //지도의 최소 줌 레벨
        zoomControl: true, //줌 컨트롤의 표시 여부
        zoomControlOptions: {
            style: naver.maps.ZoomControlStyle.SMALL,
            position: naver.maps.Position.RIGHT_BOTTOM
        }
    };
    map = new naver.maps.Map('map', mapOptions);

    function getMarker(listMap){
        //맵 초기화
        map = new naver.maps.Map('map', mapOptions);

        dataList = listMap.result
        var resAddrdetail = "";
        var index = 0;
        for( var i=0; i < dataList.length; i++ ){
            var addr = dataList[i].location + dataList[i].loc_num;
            bldgName = dataList[i].name;
            bldgPrice = dataList[i].price;
            naver.maps.Service.geocode({
                address: addr,
            }, function(status, response) {
                if (status !== naver.maps.Service.Status.OK) {
                }
                var result = response.result, // 검색 결과의 컨테이너
                items = result.items; // 검색 결과의 배열
                var lng = items[0].point.x;
                var lat = items[0].point.y;
                resAddrdetail = items[0].addrdetail.sido + "-" + items[0].addrdetail.sigugun + "-" + items[0].addrdetail.dongmyun + "-" +  items[0].addrdetail.rest
                var houses = dataList[index]; 

                marker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(lat, lng),
                    map: map,
                    icon: {
                        content: [
                            '<div class="cs_mapbridge">',
                                '<div class="map_group _map_group">',
                                    '<div class="map_marker _marker">',
                                        '<div class="ico _icon" style=" position: absolute; z-index: 6000; background-image: url(' + '{% static "img/marker_each_green_64*64.png" %}' + '); width: 66px; height: 64px; background-position: -192px -64px;">',
                                            '<div><h6>' + '23' + '평</h6></div>',
                                            '<div><h6>' + houses.price + '만원</h6></div>',
                                            '<div style="display: none"><h6>' + houses.name + '</h6></div>',
                                            '<div style="display: none"><h6>' + houses.fnd_year + '</h6></div>',
                                            '<div style="display: none"><h6>' + houses.sold_date + '</h6></div>',
                                            '<div style="display: none"><h6>' + houses.location + '</h6></div>',
                                            '<div style="display: none"><h6>' + houses.loc_num + '</h6></div>',
                                            '<div style="display: none"><h6>' + houses.loc_cd + '</h6></div>',
                                            '<div style="display: none"><h6>' + houses.floor + '</h6></div>',
                                            '<div style="display: none"><h6>' + resAddrdetail + '</h6></div>',
                                        '</div>',
                                    '</div>',
                                '</div>',
                            '</div>'
                        ].join(''),
                        size: new naver.maps.Size(38, 58),
                        anchor: new naver.maps.Point(19, 58),
                    }
                });
                index += 1;
                
                //marker cluster
                markers.push(marker);
                
                //검색한 위치로 이동
                map.setCenter(marker.position);
                
                naver.maps.Event.addListener(marker, "click", function(e) {
                    var content = []
                    content = e.overlay.icon.content.replace(/(<([^>]+)>)/ig," ").split(/(\s+)/);
                    
                    var name = content[6];
                    var price = content[4];
                    var fnd_year = content[8];
                    var addr1 = content[12] + content[14] + "(" + content[18] + "층)" ;
                    var addr2 = content[20];

                    $(".top_layer").hide();
                    $("#detail_name").text(name);
                    $("#detail_addr").text(addr1);
                    $("#detail_addr_detail").text(addr2);
                    $("#detail_price_avg").text(price);
                    $(".wrap_info_house").show();
                
                });
                        
                var contentString = [
                '<div class="iw_inner">',
                    '   <h3>서울특별시청</h3>',
                    '   <p>서울특별시 중구 태평로1가 31 | 서울특별시 중구 세종대로 110 서울특별시청<br />',
                        '       <img src="'+ HOME_PATH +'/img/example/hi-seoul.jpg" width="55" height="55" alt="서울시청" class="thumb" /><br />',
                        '       02-120 | 공공,사회기관 &gt; 특별,광역시청<br />',
                        '       <a href="http://www.seoul.go.kr" target="_blank">www.seoul.go.kr/</a>',
                        '   </p>',
                        '</div>'
                        ].join('');
                        
                        alert(contentString)
                        var infowindow = new naver.maps.InfoWindow({
                            content: contentString
                        });
                        
                        naver.maps.Event.addListener(marker, "mouseover", function(e) {
                            infowindow.open(map, marker);
                        });
                        
                //infowindow.open(map, marker);
            });
        }
        
        getCenterAddr()
        
    }

    function getAddr(){
        var word = $(".top_layer_keyword").val();
        $.ajax({
            type: 'GET',
            url: '{% url "getAddress" %}', 
            data: {
                "word": word
            },
            dataType: 'json',
            error: function( jqXHR, textStatus, errorThrown ){
                alert('status: ' + textStatus + '\nerror: ' + jqXHR.error )
            },
            success: function(datas){
                getMarker(datas);
            }
        });
    }

    //엔터 클릭 시 검색
    function goSearch(){
        getAddr();
    }


    function onSuccessGeolocation(position) {
        var location = new naver.maps.LatLng(position.coords.latitude,
                                             position.coords.longitude);
        map.setCenter(location); // 얻은 좌표를 지도의 중심으로 설정합니다.
        map.setZoom(10); // 지도의 줌 레벨을 변경합니다.

        marker = new naver.maps.Marker({
            position: location,
            map: map
        });

    }
    function onErrorGeolocation() {
        alert("error");
        var center = map.getCenter();
        infowindow.setContent('<div style="padding:20px;">' +
            '<h5 style="margin-bottom:5px;color:#f00;">Geolocation failed!</h5>'+ "latitude: "+ center.lat() +"<br />longitude: "+ center.lng() +'</div>');
        infowindow.open(map, center);
    }

    function getCenterAddr(){
        var center = map.getCenter();
        naver.maps.Service.reverseGeocode({
            location: new naver.maps.LatLng(center.lat(), center.lng()),
        }, function(status, response) {
            if (status !== naver.maps.Service.Status.OK) {
                return alert('Something wrong!');
            }
    
            var result = response.result, // 검색 결과의 컨테이너
                items = result.items; // 검색 결과의 배열
            
            var sido = items[0].addrdetail.sido;
            var sigun = items[0].addrdetail.sigugun;
            var dong = items[0].addrdetail.dongmyun;

            $(".btn_loc_info").text(sido + " " + sigun + " " + dong);
        });
    }

    $(document).ready(function(){
        
        $(".btn_search").click(function(){
            getAddr();
        });

        $(".btn_toggle_content").click(function(){
            $(".top_layer_info").hide();
        })
        
        $(".filter_news").click(function(){
            $(".top_layer_info").show();
        })

        $(".btn_back").click(function(){
            $(".wrap_info_house").hide();
            $(".top_layer").show();
        });

        ////왼쪽 버튼
        //뉴스보기
        $(".btn_left_news").click(function(){
            $(".top_layer_info").removeClass('visible-md');
            $(".top_layer_info").removeClass('visible-lg');
            $(".top_layer_info").css('position','relative');
            $(".top_layer_info").css('margin-top','1px');
            $(".top_layer_info").css('height','100%');
            $(".top_layer_info").css('z-index','3000');
            $(".btn_left_news_back").css('position','absolute');
            $(".btn_left_news_back").css('z-index','4000');
            $(".btn_left_news_back").css('top','12%');
            $(".btn_left_news_back").css('left','3%');
        });

        $(".btn_left_news_back").click(function(){
            location.reload();
        });
        
        //지도 내의 정보 검색
        $(".btn_left_near").click(function(){

        });

        //지도 내의 인구 표시
        $(".btn_left_poppul").click(function(){

        });
        
        ////오른쪽 버튼
        //현재 위치로 이동
        $(".btn_right_loc").click(function(){
            navigator.geolocation.getCurrentPosition(onSuccessGeolocation, onErrorGeolocation);
        });

        //지도 형태 변경 toggle 지도 형태 변경 0
        $(".btn_glob_0").click(function(e) {
            if($(".btn_glob_1").css('opacity') == '1'){
                $(".btn_glob_1").css('opacity', '0');
                $(".btn_glob_2").css('opacity', '0');
            }else{
                $(".btn_glob_1").css('opacity', '1');
                $(".btn_glob_2").css('opacity', '1');
            }

            e.preventDefault();
        
            var mapTypeId = 'NORMAL';
        
            if (map.getMapTypeId() !== naver.maps.MapTypeId[mapTypeId]) {
                map.setMapTypeId(naver.maps.MapTypeId[mapTypeId]); // 지도 유형 변경하기
        
                btns.removeClass("control-on");
                $(this).addClass("control-on");
            }
        });
        //지도 형태 변경 1
        $(".btn_glob_1").click(function(e) {
            $(".btn_glob_1").css('opacity', '0');
            $(".btn_glob_2").css('opacity', '0');
            e.preventDefault();
        
            var mapTypeId = 'HYBRID';
        
            if (map.getMapTypeId() !== naver.maps.MapTypeId[mapTypeId]) {
                map.setMapTypeId(naver.maps.MapTypeId[mapTypeId]); // 지도 유형 변경하기
        
                btns.removeClass("control-on");
                $(this).addClass("control-on");
            }
        });
        //지도 형태 변경 2
        $(".btn_glob_2").click(function(e) {
            $(".btn_glob_1").css('opacity', '0');
            $(".btn_glob_2").css('opacity', '0');
            e.preventDefault();
        
            var mapTypeId = 'TERRAIN';
        
            if (map.getMapTypeId() !== naver.maps.MapTypeId[mapTypeId]) {
                map.setMapTypeId(naver.maps.MapTypeId[mapTypeId]); // 지도 유형 변경하기
        
                btns.removeClass("control-on");
                $(this).addClass("control-on");
            }
        });
            

        //지도상 거리 표현
        $(".btn_right_dist").click(function(){
            getPathLine();
        });

        //마커 숨기기
        $(".btn_right_hide").click(function(){
            var center = map.getCenter();

            mapOptions = {
                center: new naver.maps.LatLng(center.lat(), center.lng()),
                zoom: 10,
                minZoom: 1, //지도의 최소 줌 레벨
                zoomControl: true, //줌 컨트롤의 표시 여부
                zoomControlOptions: {
                    style: naver.maps.ZoomControlStyle.SMALL,
                    position: naver.maps.Position.RIGHT_BOTTOM
                }
            }

            map = new naver.maps.Map('map', mapOptions);    
        });

        //현재 위치 체크 initiate
        getCenterAddr()

        //현재 위치 체크
        naver.maps.Event.addListener(map, 'bounds_changed', function(bounds) {
            getCenterAddr()
        });
        
    });

</script>
<script type="text/javascript" src="{% static 'js/marker_clustering.js' %}"></script>
<script type="text/javascript" src="{% static 'js/polyline.js' %}"></script>

{% endblock %}